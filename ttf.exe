#!/usr/bin/env bash

export PATH=$PWD/DejaGnu/bin:$PATH

function help() {
cat << EOF
##########################################
# USAGE: ttf.exe [options...] test.exp
# --dir               The tests in dir 'name' to run
# --ignore-dir        The names of specific dir to ignore
# --ignore-test       The names of specific testcase to ignore
# --testsuite         The testsuite dir
# --tool              The name of specific tool to run
# --target            The specific architecture to run
# --output            The output log dir
# --mail              The maillist to notify
# -v | --verbose      Emit verbose output
# -h | --help         Help
# test.exp            Run these tests
##########################################
EOF
    exit 0;
}

config_file=config/"`date +%F%M%S`_$$_"site.exp

declare -A options

options["target_list"]=options["target_triplet"]=options["target_alias"]="arm"
options["outdir"]="output"
options["src"]="testsuite"
options["tool"]="profiler"

TEMP=`getopt -o vh: --long dir:,ignore-dir:,ignore-test:,mail:,testsuite:,tool:,target:,help,verbose: -n 'example.bash' -- "$@"`

if [ $? != 0 ];then echo "Terminating..." >&2; exit 1;fi

eval set -- "$TEMP"

while true; do
    case "$1" in
        -v | --verbose)
            options["verbose"]=1;
            shift;
            ;;
        -h | --help)
            help
            shift;
            ;;
        --mail)
            options["mail"]=$2
            shift 2;
            ;;
        --ignore-dirs)
            options["ignoredirs"]=$2
            shift 2;
            ;;
        --ignore-tests)
            options["ignoretests"]=$2
            shift 2;
            ;;
        --testsuite)
            options["testsuite"]=$2
            shift 2;
            ;;
        --tool)
            options["tool"]=$2
            shift 2;
            ;;
        --output)
            options["outdir"]=$2
            shift 2;
            ;;
        --target)
            options["target"]=$2
            shift 2;
            ;;
        --) shift ; break;;
        *) echo "Error, No such opitons support"; exit 1;
    esac
done

options["srcdir"]=${options["srcdir"]}/${options["tool"]}/${options["target_list"]}

for i in "$@"
do
    j=$(echo $i | tr " " "\n")
    if [[ $j == ".exp" ]];then
        options["script"]="${options[script]} $j"
    fi
done

for key in $(echo ${!options[*]}); do
    if [[ $key != "script" && $key != "tool" ]]; then
        echo "set $key ${options[$key]}" >> $config_file
    fi
done

rm -rf output/*

$PWD/DejaGnu/bin/runtest ${options["script"]} --config $config_file $verbose

function cleanup()
{
    exit 0;
}

trap "cleanup" 0
